name: Security Tests

on:
  push:
    branches: [ main, master, claude/** ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # æ¯æ—¥åˆå‰3æ™‚ï¼ˆJST 12æ™‚ï¼‰ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ
    - cron: '0 3 * * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯

jobs:
  # ===== èªè¨¼æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³ =====
  credential-scan:
    name: èªè¨¼æƒ…å ±æ¼æ´©ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆgit-secretsã«å¿…è¦ï¼‰

      - name: BATSã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y bats

      - name: èªè¨¼æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
        run: |
          if [ -f tests/security/test_credential_exposure.bats ]; then
            bats tests/security/test_credential_exposure.bats
          else
            echo "è­¦å‘Š: èªè¨¼æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³ãƒ†ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

      - name: gitleaksã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨å®Ÿè¡Œ
        run: |
          # gitleaksã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          wget https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.1_linux_x64.tar.gz
          sudo mv gitleaks /usr/local/bin/

          # gitleaksã§ã‚¹ã‚­ãƒ£ãƒ³
          gitleaks detect --source . --report-format json --report-path gitleaks-report.json || true

          # ãƒ¬ãƒãƒ¼ãƒˆã®ç¢ºèª
          if [ -f gitleaks-report.json ] && [ -s gitleaks-report.json ]; then
            echo "âš ï¸ èªè¨¼æƒ…å ±ã®æ¼æ´©ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼"
            cat gitleaks-report.json
            exit 1
          else
            echo "âœ… èªè¨¼æƒ…å ±ã®æ¼æ´©ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          fi

      - name: ãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: gitleaks-report
          path: gitleaks-report.json

  # ===== ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆé™çš„è§£æ =====
  shellcheck:
    name: ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆé™çš„è§£æ
    runs-on: ubuntu-latest

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: shellcheckã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: é‡è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã®shellcheckå®Ÿè¡Œ
        run: |
          echo "ğŸ” é‡è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

          # é‡è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
          CRITICAL_DIRS=("DB" "deploy" "server" "security" "AWS")
          ISSUES_FOUND=0

          for dir in "${CRITICAL_DIRS[@]}"; do
            if [ -d "$dir" ]; then
              echo "ğŸ“‚ $dir ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

              # SC2086 (å¤‰æ•°ã‚¯ã‚©ãƒ¼ãƒˆ), SC2068 (é…åˆ—å±•é–‹), SC2046 (ã‚³ãƒãƒ³ãƒ‰ç½®æ›) ã‚’é‡ç‚¹ãƒã‚§ãƒƒã‚¯
              if find "$dir" -name "*.sh" -type f -exec shellcheck \
                --severity=warning \
                --shell=bash \
                --enable=all \
                --format=gcc {} + 2>&1 | tee shellcheck-${dir}.log; then
                echo "âœ… $dir: å•é¡Œãªã—"
              else
                echo "âŒ $dir: å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
                ISSUES_FOUND=1
              fi
            fi
          done

          if [ $ISSUES_FOUND -eq 1 ]; then
            echo "âš ï¸ ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
            exit 1
          fi

      - name: shellcheckãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: shellcheck-reports
          path: shellcheck-*.log

  # ===== ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ =====
  command-injection-tests:
    name: ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ¤œæŸ»
    runs-on: ubuntu-latest

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: BATSã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y bats shellcheck

      - name: ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
        run: |
          if [ -f tests/security/test_command_injection.bats ]; then
            bats tests/security/test_command_injection.bats
          else
            echo "è­¦å‘Š: ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

  # ===== Pythonå…¥åŠ›æ¤œè¨¼ãƒ†ã‚¹ãƒˆ =====
  python-security-tests:
    name: Pythonå…¥åŠ›æ¤œè¨¼ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Pythonã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install pytest pytest-cov bandit safety

      - name: å…¥åŠ›æ¤œè¨¼ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
        run: |
          if [ -f tests/security/test_input_validation.py ]; then
            python -m pytest tests/security/test_input_validation.py -v --tb=short
          else
            echo "è­¦å‘Š: å…¥åŠ›æ¤œè¨¼ãƒ†ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

      - name: Bandit ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
        run: |
          echo "ğŸ”’ Pythonã‚³ãƒ¼ãƒ‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ä¸­..."
          bandit -r . \
            -f json \
            -o bandit-report.json \
            --exclude ./tests,./venv,./env \
            -ll || true

          # é«˜ãƒ»ä¸­ãƒ¬ãƒ™ãƒ«ã®å•é¡Œã‚’è¡¨ç¤º
          if [ -f bandit-report.json ]; then
            python3 << 'EOF'
import json
import sys

with open('bandit-report.json', 'r') as f:
    report = json.load(f)

high = [r for r in report['results'] if r['issue_severity'] == 'HIGH']
medium = [r for r in report['results'] if r['issue_severity'] == 'MEDIUM']

if high:
    print(f"\nâŒ é«˜ãƒ¬ãƒ™ãƒ«ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œ: {len(high)}")
    for issue in high:
        print(f"  - {issue['filename']}:{issue['line_number']} - {issue['issue_text']}")

if medium:
    print(f"\nâš ï¸  ä¸­ãƒ¬ãƒ™ãƒ«ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œ: {len(medium)}")
    for issue in medium[:5]:  # æœ€åˆã®5ä»¶ã®ã¿è¡¨ç¤º
        print(f"  - {issue['filename']}:{issue['line_number']} - {issue['issue_text']}")

if high:
    sys.exit(1)
EOF
          fi

      - name: Safety ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
        run: |
          pip freeze > requirements-frozen.txt
          safety check --file requirements-frozen.txt --json || true

      - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: python-security-reports
          path: |
            bandit-report.json
            requirements-frozen.txt

  # ===== ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ =====
  dependency-scan:
    name: ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Trivyã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          wget https://github.com/aquasecurity/trivy/releases/download/v0.48.0/trivy_0.48.0_Linux-64bit.tar.gz
          tar -xzf trivy_0.48.0_Linux-64bit.tar.gz
          sudo mv trivy /usr/local/bin/

      - name: ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚¹ã‚­ãƒ£ãƒ³
        run: |
          trivy fs --severity HIGH,CRITICAL --format json --output trivy-report.json . || true

          # çµæœã®è¡¨ç¤º
          if [ -f trivy-report.json ]; then
            echo "ğŸ“Š è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³çµæœ:"
            trivy fs --severity HIGH,CRITICAL --format table .
          fi

      - name: Trivyãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: trivy-report
          path: trivy-report.json

  # ===== OWASP Dependency Check =====
  owasp-dependency-check:
    name: OWASPä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: OWASP Dependency-Checkã®å®Ÿè¡Œ
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'My-infra'
          path: '.'
          format: 'HTML'
          args: >
            --failOnCVSS 7
            --enableRetired

      - name: ãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: dependency-check-report
          path: reports

  # ===== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒãƒªãƒ¼ =====
  security-summary:
    name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã‚µãƒãƒªãƒ¼
    runs-on: ubuntu-latest
    needs: [credential-scan, shellcheck, command-injection-tests, python-security-tests, dependency-scan]
    if: always()

    steps:
      - name: ã‚µãƒãƒªãƒ¼ç”Ÿæˆ
        run: |
          echo "# ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ãƒ†ã‚¹ãƒˆå®Ÿè¡ŒçŠ¶æ³" >> $GITHUB_STEP_SUMMARY
          echo "- èªè¨¼æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³: ${{ needs.credential-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆé™çš„è§£æ: ${{ needs.shellcheck.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ¤œæŸ»: ${{ needs.command-injection-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Pythonå…¥åŠ›æ¤œè¨¼: ${{ needs.python-security-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ä¾å­˜é–¢ä¿‚ã‚¹ã‚­ãƒ£ãƒ³: ${{ needs.dependency-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
          if [ "${{ needs.credential-scan.result }}" != "success" ] || \
             [ "${{ needs.shellcheck.result }}" != "success" ] || \
             [ "${{ needs.command-injection-tests.result }}" != "success" ] || \
             [ "${{ needs.python-security-tests.result }}" != "success" ]; then
            echo "## âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
            echo "è©³ç´°ã¯å„ã‚¸ãƒ§ãƒ–ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "## âœ… ã™ã¹ã¦ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          fi
