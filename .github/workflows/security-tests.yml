name: Security Tests

on:
  push:
    branches: [ main, master, claude/** ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # æ¯æ—¥åˆå‰3æ™‚ï¼ˆJST 12æ™‚ï¼‰ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ
    - cron: '0 3 * * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯

# ===== 2026-02 ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³æ”»æ’ƒå¯¾ç­– =====
# GITHUB_TOKENã®æ¨©é™ã‚’æœ€å°é™ã«åˆ¶é™ (IPA 10å¤§è„…å¨ 2026: #2 ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³æ”»æ’ƒå¯¾ç­–)
permissions:
  contents: read
  security-events: write

jobs:
  # ===== èªè¨¼æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³ =====
  credential-scan:
    name: èªè¨¼æƒ…å ±æ¼æ´©ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # 2026-02: CVE-2025-30066 å¯¾ç­– â€” Actionã¯ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã§å›ºå®š
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0
          persist-credentials: false  # èªè¨¼æƒ…å ±ã®ä¸è¦ãªæ°¸ç¶šåŒ–ã‚’é˜²æ­¢

      - name: BATSã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y bats

      - name: èªè¨¼æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
        run: |
          if [ -f tests/security/test_credential_exposure.bats ]; then
            bats tests/security/test_credential_exposure.bats
          else
            echo "è­¦å‘Š: èªè¨¼æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³ãƒ†ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

      - name: gitleaksã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨å®Ÿè¡Œ
        run: |
          # gitleaks v8.21.2 (2026-02æ™‚ç‚¹ã®æœ€æ–°å®‰å®šç‰ˆ)
          GITLEAKS_VERSION="8.21.2"
          wget -q "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz"

          # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã®æ•´åˆæ€§ç¢ºèª
          if [ ! -f "gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" ]; then
            echo "ã‚¨ãƒ©ãƒ¼: gitleaksã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

          tar -xzf "gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz"
          sudo mv gitleaks /usr/local/bin/

          # gitleaksã§ã‚¹ã‚­ãƒ£ãƒ³
          gitleaks detect --source . --report-format json --report-path gitleaks-report.json || true

          # ãƒ¬ãƒãƒ¼ãƒˆã®ç¢ºèª
          if [ -f gitleaks-report.json ] && [ -s gitleaks-report.json ]; then
            echo "âš ï¸ èªè¨¼æƒ…å ±ã®æ¼æ´©ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼"
            cat gitleaks-report.json
            exit 1
          else
            echo "âœ… èªè¨¼æƒ…å ±ã®æ¼æ´©ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          fi

      - name: ãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: gitleaks-report
          path: gitleaks-report.json

  # ===== ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆé™çš„è§£æ =====
  shellcheck:
    name: ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆé™çš„è§£æ
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: shellcheckã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: é‡è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã®shellcheckå®Ÿè¡Œ
        run: |
          echo "ğŸ” é‡è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

          # é‡è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
          # 2026-02: lib/ ã¨ Validation/ ã‚’è¿½åŠ  (å…±é€šãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å“è³ªç¢ºä¿)
          CRITICAL_DIRS=("DB" "deploy" "server" "security" "AWS" "lib" "Validation")
          ISSUES_FOUND=0

          for dir in "${CRITICAL_DIRS[@]}"; do
            if [ -d "$dir" ]; then
              echo "ğŸ“‚ $dir ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

              if find "$dir" -name "*.sh" -type f -exec shellcheck \
                --severity=warning \
                --shell=bash \
                --enable=all \
                --format=gcc {} + 2>&1 | tee "shellcheck-${dir}.log"; then
                echo "âœ… $dir: å•é¡Œãªã—"
              else
                echo "âŒ $dir: å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
                ISSUES_FOUND=1
              fi
            fi
          done

          if [ $ISSUES_FOUND -eq 1 ]; then
            echo "âš ï¸ ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
            exit 1
          fi

      - name: shellcheckãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: shellcheck-reports
          path: shellcheck-*.log

  # ===== ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ =====
  command-injection-tests:
    name: ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ¤œæŸ»
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: BATSã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y bats shellcheck

      - name: ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
        run: |
          if [ -f tests/security/test_command_injection.bats ]; then
            bats tests/security/test_command_injection.bats
          else
            echo "è­¦å‘Š: ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

  # ===== Pythonå…¥åŠ›æ¤œè¨¼ãƒ†ã‚¹ãƒˆ =====
  python-security-tests:
    name: Pythonå…¥åŠ›æ¤œè¨¼ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: Pythonã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: '3.12'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install pytest pytest-cov bandit safety

      - name: å…¥åŠ›æ¤œè¨¼ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
        run: |
          if [ -f tests/security/test_input_validation.py ]; then
            python -m pytest tests/security/test_input_validation.py -v --tb=short
          else
            echo "è­¦å‘Š: å…¥åŠ›æ¤œè¨¼ãƒ†ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

      - name: Bandit ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
        run: |
          echo "ğŸ”’ Pythonã‚³ãƒ¼ãƒ‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ä¸­..."
          bandit -r . \
            -f json \
            -o bandit-report.json \
            --exclude ./tests,./venv,./env \
            -ll || true

          # é«˜ãƒ»ä¸­ãƒ¬ãƒ™ãƒ«ã®å•é¡Œã‚’è¡¨ç¤º
          if [ -f bandit-report.json ]; then
            python3 << 'EOF'
import json
import sys

with open('bandit-report.json', 'r') as f:
    report = json.load(f)

high = [r for r in report['results'] if r['issue_severity'] == 'HIGH']
medium = [r for r in report['results'] if r['issue_severity'] == 'MEDIUM']

if high:
    print(f"\nâŒ é«˜ãƒ¬ãƒ™ãƒ«ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œ: {len(high)}")
    for issue in high:
        print(f"  - {issue['filename']}:{issue['line_number']} - {issue['issue_text']}")

if medium:
    print(f"\nâš ï¸  ä¸­ãƒ¬ãƒ™ãƒ«ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œ: {len(medium)}")
    for issue in medium[:5]:
        print(f"  - {issue['filename']}:{issue['line_number']} - {issue['issue_text']}")

if high:
    sys.exit(1)
EOF
          fi

      - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: python-security-reports
          path: |
            bandit-report.json

  # ===== ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ =====
  dependency-scan:
    name: ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: Trivyã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          # Trivy v0.59.1 (2026-02æ™‚ç‚¹ã®æœ€æ–°å®‰å®šç‰ˆ)
          TRIVY_VERSION="0.59.1"
          wget -q "https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz"
          tar -xzf "trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz"
          sudo mv trivy /usr/local/bin/

      - name: ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚¹ã‚­ãƒ£ãƒ³
        run: |
          trivy fs --severity HIGH,CRITICAL --format json --output trivy-report.json . || true

          # çµæœã®è¡¨ç¤º
          if [ -f trivy-report.json ]; then
            echo "ğŸ“Š è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³çµæœ:"
            trivy fs --severity HIGH,CRITICAL --format table .
          fi

      # 2026-02: Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³è¿½åŠ  (CVE-2025-9074 å¯¾ç­–)
      - name: Dockerfileã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
        run: |
          if [ -f dockerfile ]; then
            echo "ğŸ³ Dockerfileã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ä¸­..."
            trivy config --severity HIGH,CRITICAL --format table dockerfile || true
          fi

      - name: Trivyãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: trivy-report
          path: trivy-report.json

  # ===== OWASP Dependency Check =====
  owasp-dependency-check:
    name: OWASPä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      # 2026-02: @main â†’ ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥å›ºå®š (ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³æ”»æ’ƒå¯¾ç­–)
      - name: OWASP Dependency-Checkã®å®Ÿè¡Œ
        uses: dependency-check/Dependency-Check_Action@4aab7087ab4f6ecbb6c3b8ad9e0ff8edde05c88a  # v1.1.0
        with:
          project: 'My-infra'
          path: '.'
          format: 'HTML'
          args: >
            --failOnCVSS 7
            --enableRetired

      - name: ãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: dependency-check-report
          path: reports

  # ===== 2026-02æ–°è¦: ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ =====
  supply-chain-check:
    name: ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: GitHub Actionsã®ãƒ”ãƒ³ç•™ã‚ç¢ºèª
        run: |
          echo "ğŸ”— GitHub Actionsã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³å›ºå®šã‚’ç¢ºèªä¸­..."
          PINNING_ISSUES=0

          # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚¿ã‚°å‚ç…§ã‚’æ¤œå‡º
          for workflow in .github/workflows/*.yml; do
            if [ -f "$workflow" ]; then
              # @vN ã¾ãŸã¯ @main ã®ã‚ˆã†ãªã‚¿ã‚°å‚ç…§ã‚’æ¤œå‡ºï¼ˆã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã§ãªã„ã‚‚ã®ï¼‰
              TAG_REFS=$(grep -n 'uses:.*@' "$workflow" | grep -v '@[0-9a-f]\{40\}' | grep -v '^#' || true)
              if [ -n "$TAG_REFS" ]; then
                echo "âš ï¸ $workflow: ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã§å›ºå®šã•ã‚Œã¦ã„ãªã„Action:"
                echo "$TAG_REFS"
                PINNING_ISSUES=1
              fi
            fi
          done

          if [ $PINNING_ISSUES -eq 1 ]; then
            echo ""
            echo "âŒ ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³æ”»æ’ƒãƒªã‚¹ã‚¯: Actionsã‚’ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã§å›ºå®šã—ã¦ãã ã•ã„"
            echo "å‚è€ƒ: CVE-2025-30066 (tj-actions/changed-files ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³æ”»æ’ƒ)"
            exit 1
          else
            echo "âœ… ã™ã¹ã¦ã®GitHub ActionsãŒã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã§å›ºå®šã•ã‚Œã¦ã„ã¾ã™"
          fi

      - name: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚°å›ºå®šç¢ºèª
        run: |
          echo "ğŸ³ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚°å›ºå®šã‚’ç¢ºèªä¸­..."
          ISSUES=0

          # Dockerfileã§ :latest ã‚¿ã‚°ã®ä½¿ç”¨ã‚’æ¤œå‡º
          for df in $(find . -name "dockerfile" -o -name "Dockerfile" -o -name "docker-compose*.yml" 2>/dev/null); do
            LATEST_REFS=$(grep -in ':latest' "$df" 2>/dev/null || true)
            if [ -n "$LATEST_REFS" ]; then
              echo "âš ï¸ $df: :latest ã‚¿ã‚°ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™"
              echo "$LATEST_REFS"
              ISSUES=1
            fi
          done

          if [ $ISSUES -eq 1 ]; then
            echo "æ¨å¥¨: å…·ä½“çš„ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°ã¾ãŸã¯ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆå€¤ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„"
          else
            echo "âœ… :latest ã‚¿ã‚°ã®ä½¿ç”¨ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          fi

      - name: ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹å–å¾—ã®æ¤œè¨¼
        run: |
          echo "ğŸŒ å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹å–å¾—ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç¢ºèªä¸­..."

          # curl | bash / wget | sh ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡ºï¼ˆå±é™ºãªãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œï¼‰
          PIPE_EXEC=$(find . -name "*.sh" -type f \
            -exec grep -ln 'curl.*|.*sh\|curl.*|.*bash\|wget.*|.*sh\|wget.*|.*bash' {} \; 2>/dev/null || true)

          if [ -n "$PIPE_EXEC" ]; then
            echo "âš ï¸ å±é™ºãªå¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ:"
            echo "$PIPE_EXEC"
            echo ""
            echo "æ¨å¥¨: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰â†’æ¤œè¨¼â†’å®Ÿè¡Œ ã®æ‰‹é †ã«å¤‰æ›´ã—ã¦ãã ã•ã„"
          else
            echo "âœ… å±é™ºãªå¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œãƒ‘ã‚¿ãƒ¼ãƒ³ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          fi

  # ===== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒãƒªãƒ¼ =====
  security-summary:
    name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã‚µãƒãƒªãƒ¼
    runs-on: ubuntu-latest
    needs: [credential-scan, shellcheck, command-injection-tests, python-security-tests, dependency-scan, supply-chain-check]
    if: always()
    permissions:
      contents: read

    steps:
      - name: ã‚µãƒãƒªãƒ¼ç”Ÿæˆ
        run: |
          echo "# ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆçµæœ (2026-02)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ãƒ†ã‚¹ãƒˆå®Ÿè¡ŒçŠ¶æ³" >> $GITHUB_STEP_SUMMARY
          echo "| ãƒ†ã‚¹ãƒˆ | çµæœ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| èªè¨¼æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³ | ${{ needs.credential-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆé™çš„è§£æ | ${{ needs.shellcheck.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ¤œæŸ» | ${{ needs.command-injection-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pythonå…¥åŠ›æ¤œè¨¼ | ${{ needs.python-security-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ä¾å­˜é–¢ä¿‚ã‚¹ã‚­ãƒ£ãƒ³ | ${{ needs.dependency-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³æ¤œè¨¼ | ${{ needs.supply-chain-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## è„…å¨ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ã‚¹å‚ç…§" >> $GITHUB_STEP_SUMMARY
          echo "- IPA æƒ…å ±ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£10å¤§è„…å¨ 2026" >> $GITHUB_STEP_SUMMARY
          echo "- CVE-2025-30066 (GitHub Actions ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³æ”»æ’ƒ)" >> $GITHUB_STEP_SUMMARY
          echo "- CVE-2025-9074 (Docker Desktop API ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ä¸å‚™)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
          if [ "${{ needs.credential-scan.result }}" != "success" ] || \
             [ "${{ needs.shellcheck.result }}" != "success" ] || \
             [ "${{ needs.command-injection-tests.result }}" != "success" ] || \
             [ "${{ needs.python-security-tests.result }}" != "success" ] || \
             [ "${{ needs.supply-chain-check.result }}" != "success" ]; then
            echo "## âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
            echo "è©³ç´°ã¯å„ã‚¸ãƒ§ãƒ–ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "## âœ… ã™ã¹ã¦ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          fi
