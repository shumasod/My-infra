#!/bin/bash
# ============================================================================
# é«˜å“è³ªãƒãƒ«ãƒãƒ„ãƒ¼ãƒ«ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# æ©Ÿèƒ½: è©©ã®ç”Ÿæˆã€ãƒ•ã‚¡ã‚¤ãƒ«åã®æš—å·åŒ–ã€ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ç›£è¦–
# ä½¿ç”¨æ–¹æ³•: ./script.sh [poem|encrypt|monitor]
# ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.1
# ============================================================================

# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®è¨­å®š
set -e                  # ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«çµ‚äº†
set -u                  # æœªå®šç¾©ã®å¤‰æ•°ä½¿ç”¨æ™‚ã«ã‚¨ãƒ©ãƒ¼
set -o pipefail         # ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®é€”ä¸­ã®ã‚¨ãƒ©ãƒ¼ã‚‚æ¤œå‡º

# ã‚¨ãƒ©ãƒ¼å‡¦ç†é–¢æ•°
handle_error() {
    local line_no=$1
    local command=$2
    echo "ã‚¨ãƒ©ãƒ¼: ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã®è¡Œ ${line_no} ã§ \"${command}\" ã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ" >&2
    exit 1
}

# ã‚¨ãƒ©ãƒ¼ãƒˆãƒ©ãƒƒãƒ—ã®è¨­å®š
trap 'handle_error ${LINENO} "$BASH_COMMAND"' ERR

# å¿…è¦ãªã‚³ãƒãƒ³ãƒ‰ã®ç¢ºèª
check_requirements() {
    local commands=("$@")
    local missing=()
    
    for cmd in "${commands[@]}"; do
        if ! command -v "$cmd" &> /dev/null; then
            missing+=("$cmd")
        fi
    done
    
    if [ ${#missing[@]} -ne 0 ]; then
        echo "ã‚¨ãƒ©ãƒ¼: æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“: ${missing[*]}" >&2
        return 1
    fi
    
    return 0
}

# ============================================================================
# 1. ãƒ©ãƒ³ãƒ€ãƒ ãªè©©ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼
# ä½¿ç”¨æ³•: generate_poem [è¡Œæ•°]
# ============================================================================
generate_poem() {
    local lines=${1:-4}  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯4è¡Œ
    
    # æ•°å€¤ãƒã‚§ãƒƒã‚¯
    if ! [[ "$lines" =~ ^[0-9]+$ ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: è¡Œæ•°ã¯æ•°å€¤ã§æŒ‡å®šã—ã¦ãã ã•ã„" >&2
        return 1
    fi
    
    # è©©ã®è¦ç´ 
    local -a adjectives=("èµ¤ã„" "é’ã„" "é™ã‹ãª" "æ¿€ã—ã„" "å„ªã—ã„" "å„šã„" "çœ©ã—ã„" "å¤ã„")
    local -a nouns=("æµ·" "ç©º" "é¢¨" "æ˜Ÿ" "é›¨" "æœˆ" "å…‰" "é“" "é›²")
    local -a verbs=("è¸Šã‚‹" "æ­Œã†" "çœ ã‚‹" "è¼ã" "å›ã" "æ¶ˆãˆã‚‹" "å¿˜ã‚Œã‚‹" "æ˜ ã‚‹")
    
    local adj noun verb
    local adj_count=${#adjectives[@]}
    local noun_count=${#nouns[@]}
    local verb_count=${#verbs[@]}
    
    echo "ã€ä¸æ€è­°ãªè©©ã€"
    echo "------------"
    
    # ç–‘ä¼¼ä¹±æ•°åˆæœŸåŒ–ï¼ˆã‚ˆã‚Šè‰¯ã„ä¹±æ•°ã®ãŸã‚ã«ï¼‰
    RANDOM=$$$(date +%s)
    
    for ((i=1; i<=lines; i++)); do
        adj="${adjectives[RANDOM % adj_count]}"
        noun="${nouns[RANDOM % noun_count]}"
        verb="${verbs[RANDOM % verb_count]}"
        echo "${adj}${noun}ãŒ${verb}"
    done
    echo "------------"
    
    return 0
}

# ============================================================================
# 2. ãƒ•ã‚¡ã‚¤ãƒ«åæš—å·åŒ–ãƒ„ãƒ¼ãƒ«
# ä½¿ç”¨æ³•: encrypt_filenames [ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ‘ã‚¹]
# ============================================================================
encrypt_filenames() {
    local dir_path=${1:-.}  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
    local mapping_file="filename_mapping.txt"
    
    # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå­˜åœ¨ç¢ºèª
    if [ ! -d "$dir_path" ]; then
        echo "ã‚¨ãƒ©ãƒ¼: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª '$dir_path' ãŒå­˜åœ¨ã—ã¾ã›ã‚“" >&2
        return 1
    fi
    
    # æ›¸ãè¾¼ã¿æ¨©é™ç¢ºèª
    if [ ! -w "$dir_path" ]; then
        echo "ã‚¨ãƒ©ãƒ¼: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª '$dir_path' ã¸ã®æ›¸ãè¾¼ã¿æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“" >&2
        return 1
    fi
    
    # ä¾å­˜ã‚³ãƒãƒ³ãƒ‰ç¢ºèª
    check_requirements "md5sum" || return 1
    
    # æ“ä½œå‰ã®ç¢ºèª
    echo "è­¦å‘Š: ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«åãŒãƒãƒƒã‚·ãƒ¥åŒ–ã•ã‚Œã¾ã™"
    echo "ç¶šè¡Œã™ã‚‹ã«ã¯ 'yes' ã¨å…¥åŠ›ã—ã¦ãã ã•ã„:"
    read -r confirm
    if [ "$confirm" != "yes" ]; then
        echo "æ“ä½œã‚’ä¸­æ­¢ã—ã¾ã—ãŸ"
        return 0
    fi
    
    # ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ•ã‚¡ã‚¤ãƒ«åˆæœŸåŒ–
    echo "# å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«å -> æš—å·åŒ–ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«å" > "$mapping_file"
    echo "# $(date)" >> "$mapping_file"
    echo "----------------------------" >> "$mapping_file"
    
    # ãƒ•ã‚¡ã‚¤ãƒ«åã®æš—å·åŒ–
    local count=0
    find "$dir_path" -type f -maxdepth 1 | while read -r file; do
        # è‡ªåˆ†è‡ªèº«ã¨ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã¯é™¤å¤–
        if [[ "$file" == *"$0"* || "$file" == *"$mapping_file"* ]]; then
            continue
        fi
        
        local filename
        filename=$(basename "$file")
        local new_name
        new_name=$(echo "$filename" | md5sum | cut -d' ' -f1)
        local extension
        extension="${filename##*.}"
        
        # æ‹¡å¼µå­ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ä»˜åŠ 
        if [ "$extension" != "$filename" ]; then
            new_name="${new_name}.${extension}"
        fi
        
        # ç§»å‹•ã‚’å®Ÿè¡Œ
        mv "$file" "${dir_path}/${new_name}"
        echo "$filename -> $new_name" | tee -a "$mapping_file"
        ((count++))
    done
    
    echo "----------------------------"
    echo "å‡¦ç†å®Œäº†: $count ãƒ•ã‚¡ã‚¤ãƒ«ã®åå‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ"
    echo "å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«åã¨æš—å·åŒ–ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒãƒƒãƒ”ãƒ³ã‚°ã¯ '$mapping_file' ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ"
    
    return 0
}

# ============================================================================
# 3. ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ç›£è¦–ã¨çµµæ–‡å­—ãƒ¬ãƒãƒ¼ãƒˆ
# ä½¿ç”¨æ³•: emoji_resource_monitor [é–“éš”ç§’æ•°] [ç¹°ã‚Šè¿”ã—å›æ•°]
# ============================================================================
emoji_resource_monitor() {
    local interval=${1:-5}       # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯5ç§’é–“éš”
    local iterations=${2:-0}     # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç„¡é™ãƒ«ãƒ¼ãƒ—ï¼ˆ0ï¼‰
    local count=0
    
    # æ•°å€¤ãƒã‚§ãƒƒã‚¯
    if ! [[ "$interval" =~ ^[0-9]+$ ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: é–“éš”ã¯æ•°å€¤ã§æŒ‡å®šã—ã¦ãã ã•ã„" >&2
        return 1
    fi
    
    if ! [[ "$iterations" =~ ^[0-9]+$ ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: ç¹°ã‚Šè¿”ã—å›æ•°ã¯æ•°å€¤ã§æŒ‡å®šã—ã¦ãã ã•ã„" >&2
        return 1
    fi
    
    # ä¾å­˜ã‚³ãƒãƒ³ãƒ‰ç¢ºèª
    check_requirements "top" "free" "df" "awk" || return 1
    
    echo "ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã™ (Ctrl+C ã§çµ‚äº†)"
    echo "é–“éš”: ${interval}ç§’ | ç¹°ã‚Šè¿”ã—: ${iterations:-'ç„¡é™'}"
    echo "---------------------------------------------------"
    echo "ğŸ”¥=é«˜CPUä½¿ç”¨ç‡ âš¡=ä¸­CPUä½¿ç”¨ç‡ ğŸ˜Š=ä½CPUä½¿ç”¨ç‡"
    echo "ğŸ’¥=é«˜ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ ğŸ’¡=ä¸­ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ ğŸ’¤=ä½ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡"
    echo "ğŸš¨=é«˜ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡ ğŸ“¦=ä¸­ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡ ğŸ’¾=ä½ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡"
    echo "---------------------------------------------------"
    
    # çµ‚äº†ã‚·ã‚°ãƒŠãƒ«ã®ãƒˆãƒ©ãƒƒãƒ—
    trap 'echo "ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚’çµ‚äº†ã—ã¾ã™"; return 0' INT TERM
    
    while true; do
        # CPUä½¿ç”¨ç‡ã‚’å–å¾—
        local cpu_usage
        cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2 + $4}')
        
        # ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ã‚’å–å¾—
        local mem_usage
        mem_usage=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100}')
        
        # ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡ã‚’å–å¾—
        local disk_usage
        disk_usage=$(df -h / | awk '/\// {print $5}' | sed 's/%//')
        
        # çµµæ–‡å­—ã®è¨­å®š
        local cpu_emoji mem_emoji disk_emoji
        
        # CPUçµµæ–‡å­—
        if (( $(echo "$cpu_usage > 80" | bc -l 2>/dev/null) )); then
            cpu_emoji="ğŸ”¥"
        elif (( $(echo "$cpu_usage > 50" | bc -l 2>/dev/null) )); then
            cpu_emoji="âš¡"
        else
            cpu_emoji="ğŸ˜Š"
        fi
        
        # ãƒ¡ãƒ¢ãƒªçµµæ–‡å­—
        if (( $(echo "$mem_usage > 80" | bc -l 2>/dev/null) )); then
            mem_emoji="ğŸ’¥"
        elif (( $(echo "$mem_usage > 50" | bc -l 2>/dev/null) )); then
            mem_emoji="ğŸ’¡"
        else
            mem_emoji="ğŸ’¤"
        fi
        
        # ãƒ‡ã‚£ã‚¹ã‚¯çµµæ–‡å­—
        if (( disk_usage > 80 )); then
            disk_emoji="ğŸš¨"
        elif (( disk_usage > 50 )); then
            disk_emoji="ğŸ“¦"
        else
            disk_emoji="ğŸ’¾"
        fi
        
        # çµæœè¡¨ç¤º
        echo "$(date '+%Y-%m-%d %H:%M:%S') | "
        echo "CPU: ${cpu_usage}% ${cpu_emoji} | "
        echo "ãƒ¡ãƒ¢ãƒª: ${mem_usage}% ${mem_emoji} | "
        echo "ãƒ‡ã‚£ã‚¹ã‚¯: ${disk_usage}% ${disk_emoji}"
        
        # ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã¨çµ‚äº†æ¡ä»¶
        ((count++))
        if [ "$iterations" -gt 0 ] && [ "$count" -ge "$iterations" ]; then
            echo "æŒ‡å®šã•ã‚ŒãŸå›æ•°ã®ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãŒå®Œäº†ã—ã¾ã—ãŸ"
            break
        fi
        
        # æ¬¡ã®æ›´æ–°ã¾ã§å¾…æ©Ÿ
        sleep "$interval"
    done
    
    return 0
}

# ============================================================================
# ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œéƒ¨åˆ†
# ============================================================================
main() {
    # ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
    show_help() {
        cat << EOF
ä½¿ç”¨æ–¹æ³•: $0 <ã‚³ãƒãƒ³ãƒ‰> [ã‚ªãƒ—ã‚·ãƒ§ãƒ³]

ã‚³ãƒãƒ³ãƒ‰:
  poem [è¡Œæ•°]            - ãƒ©ãƒ³ãƒ€ãƒ ãªè©©ã‚’ç”Ÿæˆã—ã¾ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼š4è¡Œï¼‰
  encrypt [ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª]  - æŒ‡å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æš—å·åŒ–ã—ã¾ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼‰
  monitor [é–“éš”] [å›æ•°]   - ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ã‚’ç›£è¦–ã—çµµæ–‡å­—ã§è¡¨ç¤ºã—ã¾ã™
                          é–“éš”ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5ç§’ã€å›æ•°ã¯0ã§ç„¡é™ã«å®Ÿè¡Œ

ä¾‹:
  $0 poem 6           # 6è¡Œã®è©©ã‚’ç”Ÿæˆ
  $0 encrypt ./data   # ./data ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æš—å·åŒ–
  $0 monitor 10 5     # 10ç§’é–“éš”ã§5å›ãƒªã‚½ãƒ¼ã‚¹çŠ¶æ…‹ã‚’è¡¨ç¤º
EOF
    }
    
    # ã‚³ãƒãƒ³ãƒ‰åˆ†å²
    case "${1:-help}" in
        "poem")
            generate_poem "${2:-4}"
            ;;
        "encrypt")
            encrypt_filenames "${2:-.}"
            ;;
        "monitor")
            emoji_resource_monitor "${2:-5}" "${3:-0}"
            ;;
        "help"|"-h"|"--help")
            show_help
            ;;
        *)
            echo "ã‚¨ãƒ©ãƒ¼: ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰ '${1:-}'" >&2
            show_help
            return 1
            ;;
    esac
    
    return 0
}

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ
main "$@"
