# ネットワーク監視ツール 技術解説書

## 1. 概要

このアプリケーションは、インターネット接続を定期的に監視し、接続が切断された場合に自動的に再接続を試みるツールです。主に以下の機能を提供します：

- 複数のWebサイトに対する接続監視
- 接続切れ検出時の自動再接続
- OS固有のネットワーク再接続コマンド実行
- 詳細なログ出力


## 2. 設計思想

このツールは以下の設計原則に基づいて実装されています：

### 2.1 機能性と堅牢性

- **エラーハンドリング**: すべてのネットワーク操作と外部コマンド実行には適切な例外処理が施されています
- **OS互換性**: Linux、macOS、Windowsの各OSに対応した再接続コマンドの提供
- **冗長性**: 複数URLの監視による信頼性の向上

### 2.2 使いやすさ

- **詳細なログ出力**: タイムスタンプとログレベルを含む明確なログメッセージ
- **コマンドライン設定**: 監視間隔、再試行回数、対象URLなどをカスタマイズ可能
- **ヘルプ機能**: 使用方法の説明と例の提供

### 2.3 保守性

- **モジュール化**: 論理的に関連する機能のグループ化
- **関数単位の責務**: 各関数は明確に定義された単一の責務を持つ
- **詳細なドキュメント**: 関数とデータ型に対する説明的なコメント

## 3. システム構成

### 3.1 コアデータ型

```haskell
-- アプリケーションの設定
data Config = Config
  { checkUrls  :: [String]  -- 監視対象のURL一覧
  , interval   :: Int       -- 監視間隔（秒）
  , maxRetries :: Int       -- 再接続の最大試行回数
  , verbose    :: Bool      -- 詳細ログ出力フラグ
  }

-- ログレベル
data LogLevel = Info | Warning | Error | Debug
```

### 3.2 主要コンポーネント

1. **ログ管理システム**: 異なるレベルのログ出力を提供
2. **ネットワーク接続チェック**: 指定されたURLへの接続テスト
3. **ネットワーク再接続**: OS固有のコマンド実行による再接続
4. **監視ループ**: 定期的な接続チェックと再接続の試行
5. **コマンドライン処理**: 引数解析と設定の構築

## 4. 主要アルゴリズムとフロー

### 4.1 ネットワーク監視の基本フロー

```
1. 設定された複数のURLに対して接続テストを実行
2. 一つでも接続可能であれば、正常と判断
3. すべてのURLに接続できない場合：
   a. 再接続コマンドを実行
   b. 一定時間待機
   c. 再度接続テスト
   d. 最大再試行回数まで繰り返す
```

### 4.2 再接続処理フロー

```
1. OS種別の検出
2. OS固有の再接続コマンドの決定
3. コマンドの実行（シェル経由）
4. 実行結果の分析
5. 成功/失敗の判定と報告
```

## 5. 実装の詳細

### 5.1 ネットワーク接続チェック

```haskell
checkNetworkConnection :: String -> IO Bool
```

この関数は、指定されたURLに対してHTTPリクエストを行い、応答のステータスコードを検証します。200-299の範囲のステータスコードは成功とみなされます。ネットワークエラーや例外は適切にハンドリングされ、接続失敗としてFalseを返します。

### 5.2 ネットワーク再接続

```haskell
reconnectNetwork :: IO Bool
```

この関数は、現在のOSに適したネットワーク再接続コマンドを取得し、それをシェル経由で実行します。コマンド実行の結果（標準出力と標準エラー出力）を分析し、再接続の成功/失敗を判定します。エラーハンドリングも組み込まれており、コマンド実行が例外で失敗した場合もサポートしています。

### 5.3 監視ループ

```haskell
monitorNetwork :: Config -> Int -> IO ()
```

このループ関数は、設定された間隔で接続チェックを行い、必要に応じて再接続処理を実行します。再接続の試行回数を管理し、最大試行回数に達した場合は待機してカウントをリセットします。接続が正常な場合も、異常な場合も、適切なログメッセージを出力します。

## 6. 設定オプション

アプリケーションは以下のコマンドライン引数をサポートしています：

| オプション | 説明 | デフォルト |
|----------|------|-----------|
| `--help`, `-h` | ヘルプメッセージを表示 | - |
| `--interval=N` | 監視間隔を N 秒に設定 | 300（5分） |
| `--retries=N` | 最大再試行回数を N に設定 | 3 |
| `--verbose`, `-v` | 詳細ログを出力 | false |
| `--url=URL` | チェックするURLを追加 | google.com, yahoo.co.jp |

## 7. 実行例

```bash
$ ./network-monitor --interval=60 --retries=5 --url=https://example.com --verbose
===============================================
=          ネットワーク監視ツール            =
===============================================
2025-05-18 12:34:56 [INFO] ネットワーク監視を開始します (間隔: 60秒, 最大再試行回数: 5)
2025-05-18 12:34:56 [INFO] 監視URL: ["https://example.com","https://www.google.com","https://www.yahoo.co.jp"]
2025-05-18 12:34:56 [INFO] 初期接続チェックを実行しています...
2025-05-18 12:34:56 [DEBUG] 接続確認中: https://example.com
2025-05-18 12:34:57 [DEBUG] https://example.com への接続結果: 200
2025-05-18 12:34:57 [DEBUG] 接続確認中: https://www.google.com
2025-05-18 12:34:57 [DEBUG] https://www.google.com への接続結果: 200
2025-05-18 12:34:57 [DEBUG] 接続確認中: https://www.yahoo.co.jp
2025-05-18 12:34:58 [DEBUG] https://www.yahoo.co.jp への接続結果: 200
2025-05-18 12:34:58 [DEBUG] https://example.com: 接続OK
2025-05-18 12:34:58 [DEBUG] https://www.google.com: 接続OK
2025-05-18 12:34:58 [DEBUG] https://www.yahoo.co.jp: 接続OK
2025-05-18 12:34:58 [INFO] 初期接続チェックに成功しました。
2025-05-18 12:34:58 [INFO] 監視ループを開始します...
2025-05-18 12:34:58 [INFO] ネットワーク接続が正常です
...
```

## 8. エラーハンドリング

このアプリケーションは、以下のエラー状況に対処するための堅牢なエラーハンドリングを実装しています：

1. **ネットワーク接続エラー**: 接続障害、タイムアウト、不正なレスポンスなど
2. **コマンド実行エラー**: 権限不足、不正なコマンド、実行失敗など
3. **入力検証エラー**: 無効なコマンドライン引数、不正な設定値など

各エラー状況は適切にログに記録され、可能な場合は回復処理が実行されます。

## 9. 拡張性

システムは以下のような拡張が容易に行えるように設計されています：

1. **新しいOS対応**: `getReconnectCommand`関数に新しいOSケースを追加
2. **接続チェック方法の追加**: 新しい接続確認方法を実装して`checkAllConnections`に統合
3. **設定オプションの拡張**: 新しいコマンドライン引数を`parseArgs`関数に追加
4. **通知機能の追加**: 接続状態変化時のメール/SMS通知など
5. **Web管理インターフェース**: 状態確認と設定変更用のWebインターフェース

## 10. パフォーマンスと最適化

システムは長時間稼働することを前提に設計されており、以下の点で最適化されています：

1. **低リソース使用**: 監視間隔が長いため、CPU/メモリ使用が最小限
2. **エラー回復**: 一時的なネットワーク障害から自動回復
3. **スケーラビリティ**: 多数のURLを監視する場合も効率的に動作

## 11. セキュリティの考慮事項

1. **特権コマンド実行**: 一部のネットワーク再接続コマンドは特権（sudo）が必要
2. **ネットワーク接続**: HTTPS経由でのセキュアな接続チェック
3. **入力検証**: コマンドライン引数の厳格な検証によるインジェクション防止

## 12. 将来の拡張可能性

このツールは以下の方向に拡張することができます：

1. **詳細なネットワーク診断**: ping、tracerouteなどの診断ツール統合
2. **高度な再接続戦略**: 段階的な再接続試行（ソフト→ハードリセット）
3. **接続品質モニタリング**: 速度とレイテンシの測定
4. **データ収集と分析**: 接続統計の長期保存と分析
5. **VPN管理**: VPN接続の監視と自動再接続

## 13. まとめ

このネットワーク監視ツールは、Haskellの型安全性と例外処理機能を活用して、信頼性の高いネットワーク接続監視ソリューションを提供します。複数URLの監視、OS固有の再接続処理、詳細なログ出力など、幅広い機能を備えながらも、シンプルなコマンドラインインターフェースで操作できます。エラーハンドリングと回復メカニズムを備えた設計により、長期間の安定稼働が可能です。
