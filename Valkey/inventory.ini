# Valkey Cluster Inventory File
# =============================================================================
# このインベントリファイルはValkeyクラスターのノード構成を定義します
# =============================================================================

# -----------------------------------------------------------------------------
# クラスター全体のノード定義
# -----------------------------------------------------------------------------
[valkey_cluster]
valkey-node1 ansible_host=192.168.1.101 valkey_node_role=master valkey_node_id=1
valkey-node2 ansible_host=192.168.1.102 valkey_node_role=master valkey_node_id=2
valkey-node3 ansible_host=192.168.1.103 valkey_node_role=master valkey_node_id=3
valkey-node4 ansible_host=192.168.1.104 valkey_node_role=replica valkey_node_id=4 valkey_master_node=valkey-node1
valkey-node5 ansible_host=192.168.1.105 valkey_node_role=replica valkey_node_id=5 valkey_master_node=valkey-node2
valkey-node6 ansible_host=192.168.1.106 valkey_node_role=replica valkey_node_id=6 valkey_master_node=valkey-node3

# -----------------------------------------------------------------------------
# マスターノード
# -----------------------------------------------------------------------------
[valkey_masters]
valkey-node1
valkey-node2
valkey-node3

# -----------------------------------------------------------------------------
# レプリカノード
# -----------------------------------------------------------------------------
[valkey_replicas]
valkey-node4
valkey-node5
valkey-node6

# -----------------------------------------------------------------------------
# クラスター全体の共通変数
# -----------------------------------------------------------------------------
[valkey_cluster:vars]
# SSH接続設定
ansible_user=ubuntu
ansible_ssh_private_key_file=~/.ssh/id_rsa
ansible_python_interpreter=/usr/bin/python3
ansible_connection=ssh
ansible_ssh_common_args='-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=30'

# タイムアウトと再試行設定
ansible_ssh_retries=3
ansible_timeout=30

# 権限昇格設定
ansible_become=yes
ansible_become_method=sudo
ansible_become_user=root

# -----------------------------------------------------------------------------
# 環境別設定（必要に応じてコメントアウトを外す）
# -----------------------------------------------------------------------------

# 開発環境
#[valkey_cluster:vars]
#environment=development
#valkey_max_memory=1gb
#valkey_password=""

# ステージング環境
#[valkey_cluster:vars]
#environment=staging
#valkey_max_memory=2gb
#valkey_password="{{ lookup('env', 'VALKEY_STAGING_PASSWORD') }}"

# 本番環境
#[valkey_cluster:vars]
#environment=production
#valkey_max_memory=4gb
#valkey_password="{{ lookup('env', 'VALKEY_PRODUCTION_PASSWORD') }}"

# -----------------------------------------------------------------------------
# ネットワーク設定
# -----------------------------------------------------------------------------
[valkey_cluster:vars]
# Valkeyポート設定
valkey_port=6379
valkey_cluster_bus_port=16379

# ネットワークインターフェース（必要に応じて変更）
# valkey_bind_interface=eth0

# -----------------------------------------------------------------------------
# パフォーマンスチューニング
# -----------------------------------------------------------------------------
[valkey_cluster:vars]
# メモリ設定
valkey_max_memory=2gb
valkey_max_memory_policy=allkeys-lru

# 接続設定
valkey_tcp_backlog=511
valkey_timeout=300
valkey_tcp_keepalive=300
valkey_maxclients=10000

# 永続化設定
valkey_save_enabled=yes
valkey_rdb_compression=yes
valkey_rdb_checksum=yes

# AOF設定
valkey_appendonly=no
valkey_appendfsync=everysec

# -----------------------------------------------------------------------------
# セキュリティ設定
# -----------------------------------------------------------------------------
[valkey_cluster:vars]
# パスワード認証（本番環境では必ず設定）
valkey_password=""
valkey_requirepass="{{ valkey_password }}"

# 保護モード
valkey_protected_mode=yes

# 危険なコマンドの無効化
valkey_rename_commands=yes
valkey_disabled_commands=
  - FLUSHDB
  - FLUSHALL
  - CONFIG
  - DEBUG
  - SHUTDOWN

# -----------------------------------------------------------------------------
# ログとモニタリング
# -----------------------------------------------------------------------------
[valkey_cluster:vars]
# ログ設定
valkey_loglevel=notice
valkey_log_dir=/var/log/valkey
valkey_syslog_enabled=no

# スロークエリログ
valkey_slowlog_log_slower_than=10000
valkey_slowlog_max_len=128

# -----------------------------------------------------------------------------
# バックアップ設定
# -----------------------------------------------------------------------------
[valkey_cluster:vars]
valkey_backup_enabled=yes
valkey_backup_dir=/var/lib/valkey/backup
valkey_backup_retention_days=7

# -----------------------------------------------------------------------------
# 高可用性設定
# -----------------------------------------------------------------------------
[valkey_cluster:vars]
# クラスター設定
valkey_cluster_enabled=yes
valkey_cluster_node_timeout=15000
valkey_cluster_replica_validity_factor=10
valkey_cluster_migration_barrier=1
valkey_cluster_require_full_coverage=yes

# レプリケーション設定
valkey_replica_priority=100
valkey_replica_read_only=yes
valkey_repl_diskless_sync=no
valkey_repl_diskless_sync_delay=5

# -----------------------------------------------------------------------------
# マスターノード固有設定
# -----------------------------------------------------------------------------
[valkey_masters:vars]
valkey_node_type=master
valkey_replica_priority=100

# -----------------------------------------------------------------------------
# レプリカノード固有設定
# -----------------------------------------------------------------------------
[valkey_replicas:vars]
valkey_node_type=replica
valkey_replica_priority=50
valkey_replica_read_only=yes

# -----------------------------------------------------------------------------
# データセンター/AZ別グループ（オプション）
# -----------------------------------------------------------------------------
#[valkey_az_a]
#valkey-node1
#valkey-node4

#[valkey_az_b]
#valkey-node2
#valkey-node5

#[valkey_az_c]
#valkey-node3
#valkey-node6

# -----------------------------------------------------------------------------
# 動的インベントリ用の子グループ
# -----------------------------------------------------------------------------
[valkey_all:children]
valkey_cluster

[valkey_all:vars]
# グローバル設定をここに追加
